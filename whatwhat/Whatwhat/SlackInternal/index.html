<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>SlackInternal (whatwhat.Whatwhat.SlackInternal)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">whatwhat</a> &#x00BB; <a href="../index.html">Whatwhat</a> &#x00BB; SlackInternal</nav><header class="odoc-preamble"><h1>Module <code><span>Whatwhat.SlackInternal</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Basic"><a href="#module-Basic" class="anchor"></a><code><span><span class="keyword">module</span> Basic</span><span> = <span class="xref-unresolved">Yojson</span>.Basic</span></code></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-SlackAPIError"><a href="#exception-SlackAPIError" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">SlackAPIError</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-FrameParseFailed"><a href="#exception-FrameParseFailed" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">FrameParseFailed</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_response"><a href="#val-check_response" class="anchor"></a><code><span><span class="keyword">val</span> check_response : <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <span class="xref-unresolved">Cohttp_lwt</span>.Body.t)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>TODO: Use this</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-message"><a href="#type-message" class="anchor"></a><code><span><span class="keyword">type</span> message</span><span> = </span><span>{</span></code><ol><li id="type-message.envelope_id" class="def record field anchored"><a href="#type-message.envelope_id" class="anchor"></a><code><span>envelope_id : string;</span></code></li><li id="type-message.text" class="def record field anchored"><a href="#type-message.text" class="anchor"></a><code><span>text : string;</span></code></li><li id="type-message.user" class="def record field anchored"><a href="#type-message.user" class="anchor"></a><code><span>user : string;</span></code></li><li id="type-message.channel" class="def record field anchored"><a href="#type-message.channel" class="anchor"></a><code><span>channel : string;</span></code></li><li id="type-message.timestamp" class="def record field anchored"><a href="#type-message.timestamp" class="anchor"></a><code><span>timestamp : string;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A message in a channel.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_message"><a href="#val-pp_message" class="anchor"></a><code><span><span class="keyword">val</span> pp_message : 
  <span><span class="xref-unresolved">Ppx_deriving_runtime</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-message">message</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppx_deriving_runtime</span>.unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_message"><a href="#val-show_message" class="anchor"></a><code><span><span class="keyword">val</span> show_message : <span><a href="#type-message">message</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppx_deriving_runtime</span>.string</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-slash_command"><a href="#type-slash_command" class="anchor"></a><code><span><span class="keyword">type</span> slash_command</span><span> = </span><span>{</span></code><ol><li id="type-slash_command.envelope_id" class="def record field anchored"><a href="#type-slash_command.envelope_id" class="anchor"></a><code><span>envelope_id : string;</span></code></li><li id="type-slash_command.channel_id" class="def record field anchored"><a href="#type-slash_command.channel_id" class="anchor"></a><code><span>channel_id : string;</span></code></li><li id="type-slash_command.user_id" class="def record field anchored"><a href="#type-slash_command.user_id" class="anchor"></a><code><span>user_id : string;</span></code></li><li id="type-slash_command.command" class="def record field anchored"><a href="#type-slash_command.command" class="anchor"></a><code><span>command : string;</span></code></li><li id="type-slash_command.text" class="def record field anchored"><a href="#type-slash_command.text" class="anchor"></a><code><span>text : string;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A slash-command run in a channel the bot is in.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_slash_command"><a href="#val-pp_slash_command" class="anchor"></a><code><span><span class="keyword">val</span> pp_slash_command : 
  <span><span class="xref-unresolved">Ppx_deriving_runtime</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-slash_command">slash_command</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppx_deriving_runtime</span>.unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_slash_command"><a href="#val-show_slash_command" class="anchor"></a><code><span><span class="keyword">val</span> show_slash_command : <span><a href="#type-slash_command">slash_command</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppx_deriving_runtime</span>.string</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-slack_event"><a href="#type-slack_event" class="anchor"></a><code><span><span class="keyword">type</span> slack_event</span><span> = </span></code><ol><li id="type-slack_event.Ping" class="def variant constructor anchored"><a href="#type-slack_event.Ping" class="anchor"></a><code><span>| </span><span><span class="constructor">Ping</span></span></code></li><li id="type-slack_event.Hello" class="def variant constructor anchored"><a href="#type-slack_event.Hello" class="anchor"></a><code><span>| </span><span><span class="constructor">Hello</span> <span class="keyword">of</span> int</span></code></li><li id="type-slack_event.Message" class="def variant constructor anchored"><a href="#type-slack_event.Message" class="anchor"></a><code><span>| </span><span><span class="constructor">Message</span> <span class="keyword">of</span> <a href="#type-message">message</a></span></code></li><li id="type-slack_event.PingMessage" class="def variant constructor anchored"><a href="#type-slack_event.PingMessage" class="anchor"></a><code><span>| </span><span><span class="constructor">PingMessage</span> <span class="keyword">of</span> <a href="#type-message">message</a></span></code></li><li id="type-slack_event.SlashCommand" class="def variant constructor anchored"><a href="#type-slack_event.SlashCommand" class="anchor"></a><code><span>| </span><span><span class="constructor">SlashCommand</span> <span class="keyword">of</span> <a href="#type-slash_command">slash_command</a></span></code></li></ol></div><div class="spec-doc"><p>The types of Slack events that we know how to handle.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_slack_event"><a href="#val-pp_slack_event" class="anchor"></a><code><span><span class="keyword">val</span> pp_slack_event : 
  <span><span class="xref-unresolved">Ppx_deriving_runtime</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-slack_event">slack_event</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppx_deriving_runtime</span>.unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_slack_event"><a href="#val-show_slack_event" class="anchor"></a><code><span><span class="keyword">val</span> show_slack_event : <span><a href="#type-slack_event">slack_event</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppx_deriving_runtime</span>.string</span></code></div></div><p>--- CONNECTION SETUP ------------------------ In this library, we use the WebSocket protocol to connect to Slack using 'socket mode'. This requires an app-level token (see the Config module).</p><div class="odoc-spec"><div class="spec value anchored" id="val-get_websocket_url"><a href="#val-get_websocket_url" class="anchor"></a><code><span><span class="keyword">val</span> get_websocket_url : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Uri</span>.t <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Obtain the web socket URL from Slack, using an app-level token. This URL will be the one used for communication.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect_websocket"><a href="#val-connect_websocket" class="anchor"></a><code><span><span class="keyword">val</span> connect_websocket : <span><span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Websocket_lwt_unix</span>.conn <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Connect to the URL and return an open websocket connection, which can then be used to send and receive 'frames' .</p></div></div><p>--- FRAME PARSERS --------------------------- Communication over the WebSocket protocol occurs via 'frames'. These are defined in RFC 6455: https://datatracker.ietf.org/doc/html/rfc6455#section-5 The most important components of a frame are the 'opcode', which indicates the 'type' of frame that is being sent, and the 'payload', which is the actual contents that we are interested in.</p><p>In OCaml, a frame is defined by the Websocket.Frame.t type: https://ocaml.org/p/websocket/2.2/doc/Websocket_lwt/Frame/index.html</p><p>The functions in this section parse raw frames into known Slack events, so that they can subsequently be handled.</p><div class="odoc-spec"><div class="spec value anchored" id="val-parse_as_slash_command"><a href="#val-parse_as_slash_command" class="anchor"></a><code><span><span class="keyword">val</span> parse_as_slash_command : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Parse frame as a slash command</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_as_message"><a href="#val-parse_as_message" class="anchor"></a><code><span><span class="keyword">val</span> parse_as_message : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Parse frame as a message</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_as_pingmessage"><a href="#val-parse_as_pingmessage" class="anchor"></a><code><span><span class="keyword">val</span> parse_as_pingmessage : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Parse frame as a ping-message</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_as_hello"><a href="#val-parse_as_hello" class="anchor"></a><code><span><span class="keyword">val</span> parse_as_hello : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Parse frame as hello</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_as_ping"><a href="#val-parse_as_ping" class="anchor"></a><code><span><span class="keyword">val</span> parse_as_ping : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Parse frame as a ping</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_frame"><a href="#val-parse_frame" class="anchor"></a><code><span><span class="keyword">val</span> parse_frame : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-slack_event">slack_event</a></span></code></div><div class="spec-doc"><p>Attempt to parse a WebSocket frame as a Slack event.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-print_frame_json"><a href="#val-print_frame_json" class="anchor"></a><code><span><span class="keyword">val</span> print_frame_json : <span><span class="xref-unresolved">Websocket</span>.Frame.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Print JSON contents of a frame to standard output.</p></div></div><p>--- EVENT HANDLERS --------------------------- Once a frame is received and parsed into an event, we must then perform some kind of action in response to it. In this library, actions are split up into 'acknowledgement' and 'handling'.</p><p>The former entails directly sending a response frame to Slack's servers, indicating that we have received the frame they sent. If this is not done, Slack starts retrying to send the frame, so it is quite important to send an acknowledgement first before actually performing any other actions. These are kept inside the SlackInternal module.</p><p>The latter means some kind of high-level, visible, response to the event. For example, this could be posting a message to the channel, or reacting to a message.</p><div class="odoc-spec"><div class="spec value anchored" id="val-pong"><a href="#val-pong" class="anchor"></a><code><span><span class="keyword">val</span> pong : <span><span class="xref-unresolved">Websocket_lwt_unix</span>.conn <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send a pong back to the server. This should be done in response to a ping.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-return_envelope"><a href="#val-return_envelope" class="anchor"></a><code><span><span class="keyword">val</span> return_envelope : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Websocket_lwt_unix</span>.conn <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send a frame back to Slack's servers indicating that an envelope has been received. This is mandatory, or else Slack will start sending retries.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-acknowledge_event"><a href="#val-acknowledge_event" class="anchor"></a><code><span><span class="keyword">val</span> acknowledge_event : <span><span class="xref-unresolved">Websocket_lwt_unix</span>.conn <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-slack_event">slack_event</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Handlers for acknowledging all types of Slack events. This is purely to keep the WebSocket connection alive, and should not need to be modified unless new types of events are added. To specify how the bot should react to incoming events, see <code>handle_event</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-post_message"><a href="#val-post_message" class="anchor"></a><code><span><span class="keyword">val</span> post_message : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Post a message to Slack.</p><p>This deliberately does NOT use the 'blocks' representation of Slack, because for some reason, blocks are wrapped to a certain width which annoyingly cannot be overridden. So the message is just passed as a (mrkdwn-formatted) string.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_reaction"><a href="#val-add_reaction" class="anchor"></a><code><span><span class="keyword">val</span> add_reaction : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-message">message</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Add a reaction to a message.</p><p>The reaction is specified as a string, without the surrounding colons. For example, if you want to react with :eyes:, pass &quot;eyes&quot; as this argument.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_current_user"><a href="#val-get_current_user" class="anchor"></a><code><span><span class="keyword">val</span> get_current_user : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Get the user ID of the current user (i.e. the bot).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_username"><a href="#val-get_username" class="anchor"></a><code><span><span class="keyword">val</span> get_username : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>string option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Get the username of a person with a given user_id. Not all user IDs correspond to real people (for example, bots don't), so those return None.</p></div></div></div></body></html>
